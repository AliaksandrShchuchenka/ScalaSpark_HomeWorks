CREATE TABLE ADS_APP_DEV.TMP_ORDER
(
	ORDER_ID INTEGER NOT NULL,
	CUSTOMER_ID INTEGER,
	CREATION_TMST TIMESTAMP,
	COMPLETION_TMST TIMESTAMP
)
ORGANIZE BY COLUMN;

CREATE TABLE ADS_APP_DEV.TMP_ORDER_ITEM
(
	ITEM_ID INTEGER NOT NULL,
	PRODUCT_ID INTEGER,
	ORDER_ID INTEGER,
	QTY INTEGER,
	PROMOTION_ID INTEGER,
	COST INTEGER
)
ORGANIZE BY COLUMN;
INSERT INTO ADS_APP_DEV.TMP_ORDER_ITEM(ITEM_ID,PRODUCT_ID,ORDER_ID,QTY,PROMOTION_ID,COST) VALUES
 (1,1,1,1,0,150)
,(2,2,1,2,0,50)
,(3,3,1,1,0,2500)
,(4,4,1,1,0,120)
,(5,5,1,2,0,90)
,(6,6,1,3,0,70)
,(7,7,2,5,0,25)
,(8,8,2,2,0,45)
,(9,9,2,10,0,2)
,(10,10,2,15,0,3)
,(11,11,2,9,0,11)
,(12,12,2,7,0,8)
,(13,13,2,5,0,2)
,(14,14,3,7,0,4)
,(15,15,3,3,0,3)
,(16,16,3,5,0,1)
,(17,17,3,4,0,4)
,(21,1,3,2,0,150)
,(22,2,3,4,0,50)
,(23,3,3,2,0,2500)
,(24,4,3,6,0,120)
,(25,5,3,2,0,90)
,(26,6,3,5,0,70)
,(27,7,3,2,0,25)
,(28,8,3,3,0,45)
,(29,9,3,4,0,2)
,(30,10,4,7,0,3)
,(31,11,4,8,0,11)
,(32,12,4,9,0,8)
,(33,13,4,10,0,2)
,(34,14,4,11,0,4)
,(35,15,4,12,0,3)
,(36,16,4,13,0,1)
,(37,17,4,14,0,4);

CREATE TABLE ADS_APP_DEV.TMP_PRODUCT
(
	PRODUCT_ID INTEGER NOT NULL,
	PRODUCT_NAME VARCHAR(255),
	CATEGORY_ID INTEGER
)
ORGANIZE BY COLUMN;

INSERT INTO ADS_APP_DEV.TMP_PRODUCT(PRODUCT_ID,PRODUCT_NAME,CATEGORY_ID) VALUES
 (1,'Monitor',1)
,(2,'Keyboard',1)
,(3,'Laptop',1)
,(4,'SSD',1)
,(5,'HDD',1)
,(6,'RAM',1)
,(7,'LaserMouse',1)
,(8,'Book',2)
,(9,'Pencil',2)
,(10,'Marker',2)
,(11,'Lamp',2)
,(12,'Paper',2)
,(13,'Potato',3)
,(14,'Tomato',3)
,(15,'Garlic',3)
,(16,'Cucumber',3)
,(17,'Carrot',3);

WITH CTE_REV
AS
(
	SELECT
		 P.CATEGORY_ID
		,P.PRODUCT_NAME
		,SUM(I.COST * I.QTY) AS REVENUE
	FROM TMP_ORDER_ITEM I
	INNER JOIN TMP_PRODUCT P
		ON I.PRODUCT_ID = P.PRODUCT_ID
	GROUP BY
		P.CATEGORY_ID
		,P.PRODUCT_NAME
)
, CTE_RESULT
AS
(
	SELECT
		ROW_NUMBER() OVER (PARTITION BY CATEGORY_ID ORDER BY REVENUE DESC) AS RN
		,CATEGORY_ID
		,PRODUCT_NAME
		,REVENUE
	FROM CTE_REV R
)
SELECT *
FROM CTE_RESULT
WHERE RN < 4;